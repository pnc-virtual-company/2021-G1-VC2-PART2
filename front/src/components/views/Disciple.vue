<template>
  <v-expansion-panels class="main">
    <div class="headerManin">
      <!-- ===================Edit disciple dialog======================== -->

      <v-dialog v-model="editdialog" max-width="600px">
        <v-card class="card">
          <v-card-title color="blue" class="text-h6">
            <span>Are you sure you want to update this item?</span>
          </v-card-title>
          <v-container>
            <v-row>
              <v-col cols="6" sm="6" id="date">
                <img src="../../assets/date.png" alt="" />
                <input
                  type="date"
                  v-model="date"
                  label="Date"
                  multiple
                  rows="1"
                  prepend-icon="mdi-alert-outline"
                />
              </v-col>

              <v-col cols="6" sm="6">
                <v-autocomplete
                  v-model="dnt"
                  :items="leavelist"
                  label="Choose discipline notice type"
                  rows="1"
                  prepend-icon="mdi-alert-outline"
                ></v-autocomplete>
              </v-col>

              <v-col cols="12" sm="12">
                <v-textarea
                  v-model="description"
                  class="mx-2"
                  label="Description"
                  rows="1"
                  prepend-icon="mdi-comment-processing-outline"
                ></v-textarea>
              </v-col>
            </v-row>
          </v-container>

          <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn color="gray darken-1" text @click="editdialog = false"
              >Cancel</v-btn
            >
            <v-btn color="green darken-1" text @click="Update(id)">OK</v-btn>
          </v-card-actions>
        </v-card>
      </v-dialog>

      <!-- ==========================End edit Dialog===================================== -->

      <v-dialog v-model="dialog" max-width="500px">
        <v-card class="cardForm">
          <v-card-title class="text-h5"
            >Are you sure you want to delete this item?</v-card-title
          >
          <v-divider></v-divider>
          <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn color="gray darken-1" text @click="dialog = false"
              >Cancel</v-btn
            >
            <v-btn color="green darken-1" text @click="Remove(id)">OK</v-btn>
          </v-card-actions>
        </v-card>
      </v-dialog>
      <!-- ==========================End Dialog===================================== -->

      <v-dialog v-model="dialog" max-width="500px">
        <v-card class="cardForm">
          <v-card-title class="text-h5"
            >Are you sure you want to delete this item?</v-card-title
          >
          <v-divider></v-divider>
          <v-card-actions>
            <v-spacer></v-spacer>
            <v-btn color="gray darken-1" text @click="dialog = false"
              >Cancel</v-btn
            >
            <v-btn color="green darken-1" text @click="Remove(id)">OK</v-btn>
          </v-card-actions>
        </v-card>
      </v-dialog>
      <!-- ==========================End Dialog===================================== -->

      <!-- ===================search============= -->
      <div class="cardheader">
        <v-card-title>
          <v-text-field
            v-if="userRole !== 'Student' && userRole !== 'Social Affair'"
            class="searchbtn"
            v-model="search"
            append-icon="mdi-magnify"
            label="Search discipline"
            color="blue darken-1"
            v-on:keyup="searchBotton"
            single-line
          ></v-text-field>
        </v-card-title>
        <v-combobox
          v-if="userRole !== 'Student'"
          v-on:keyup="selectClass"
          v-model="classes"
          :items="items"
          class="select"
          label="Select Class"
          outlined
          single-line
          dense
          color="deep-purple accent-4"
        ></v-combobox>

        <form-disciple
          v-if="userRole == 'Admin'"
          @add-discipline="getDisciples"
        ></form-disciple>
      </div>

      <v-expansion-panel v-for="disciple of disciples" :key="disciple.id">
        <v-expansion-panel-header class="header">
          <v-row>
            <v-col cols="12" sm="1">
              <v-img
                id="wearning"
                max-height="70"
                max-width="70"
                src="../../assets/stop.png"
              >
              </v-img>
            </v-col>
            <v-col cols="12" sm="2">
              <p id="dnt">{{ disciple.dnt }}</p>
            </v-col>

            <v-col cols="12" sm="3">
              <v-img
                max-height="120"
                max-width="90"
                :src="url + disciple.student.picture"
              >
              </v-img>
            </v-col>

            <v-col cols="12" sm="4">
              <div class="username">
                <div>
                  <h3 style="margin-bottom: 10px">
                    {{ disciple.student.firstName }}
                    {{ disciple.student.lastName }}
                  </h3>
                </div>
                <p>{{ disciple.class }}</p>
              </div>

              <div style="disply: flex">
                <div
                  class="date"
                  style="margin-left: 58px; margin-bottom: -23px"
                >
                  <h4>{{ disciple.date }}</h4>
                </div>

                <v-img
                  max-height="50"
                  max-width="50"
                  src="../../assets/date.png"
                  alt=""
                >
                </v-img>
              </div>
            </v-col>
          </v-row>
          <!-- ===================end button edit&delete============= -->
        </v-expansion-panel-header>
        <!-- ====================start show details========== -->
        <v-expansion-panel-content>
          {{ disciple.description }}
        </v-expansion-panel-content>

        <!-- ====================end show details=================== -->
        <div v-if="userRole !== 'Student' && userRole !== 'Social Affair'" class="btn" align="center">
          <v-icon @click="ShowDilogEdit(disciple)" color="green" left >mdi-pencil-box-multiple-outline</v-icon>
          <v-icon @click="ShowDialog(disciple)" color="#EF5350" right>mdi-delete</v-icon>
        </div>

      </v-expansion-panel>
    </div>
  </v-expansion-panels>
</template>

<script>
import axios from "../../axios-http.js";
import formDisciple from "../ui/formDisciple.vue";
export default {
  components: { formDisciple },
  data() {
    return {
      dialog: false,
      editdialog: false,
      classes: "",
      search: "",
      description: "",
      class: "",
      disciples: [],
      disFilter: [],
      id: "",
      student_id: "",
      dnt: "",
      date: "",
      userRole: "",
      url: "http://127.0.0.1:8000/storage/imagestudent/",
      leavelist: [
        "Misconduct",
        "Oral warning",
        "Warning letter",
        "Termination",
      ],
      items: [
        "WEB 2021A",
        "WEB 2021B",
        "SNA 2021",
        "WEB 2022A",
        "WEB 2022B",
        "SNA 2022",
      ],
    };
  },
  computed: {
    computedDateFormatted() {
      return this.formatDate(this.date);
    },
  },

  watch: {
    date() {
      this.dateFormatted = this.formatDate(this.date);
    },
  },
  methods: {
    Remove(id) {
      axios.delete("/disciples/" + id).then((res) => {
        this.getDisciples();
        this.dialog = false;
        return res.data;
      });
    },
    ShowDilogEdit(disciple) {
      this.editdialog = true;
      this.id = disciple.id;
      this.date = disciple.date;
      this.description = disciple.description;
      this.dnt = disciple.dnt;
    },
    Update() {
      this.editdialog = false;
      let updateDic = {
        date: this.date,
        dnt: this.dnt,
        description: this.description,
      };
      console.log(updateDic);

      axios.put("/disciples/" + this.id, updateDic).then((res) => {
        this.editdialog = false;
        this.getDisciples();
        return res.data;
      });
    },

    getDisciples() {
      let studentId = localStorage.getItem("studentId");
      axios.get("/disciples").then((res) => {
        this.disFilter = res.data;
        if (this.userRole === "Student") {
          for (let disciple of res.data) {
            if (disciple.student.id == studentId) {
              this.disciples.push(disciple);
            }
          }
        } else {
          this.disciples = res.data;
        }
      });
    },
    ShowDialog(disciple) {
      this.dialog = true;
      this.id = disciple.id;
    },
    getStudent() {
      axios.get("/students").then((res) => {
        this.studentlist = res.data;
      });
    },

    // =================Search btn=======================
    searchBotton() {
      if (this.search !== "") {
        this.disciples = this.disciples.filter(
          (disciple) =>
            disciple.student.firstName
              .toLowerCase()
              .includes(this.search.toLowerCase()) ||
            disciple.student.lastName
              .toLowerCase()
              .includes(this.search.toLowerCase())
        );
      } else {
        this.getDisciples();
      }
    },
    selectClass() {
      this.disciples = [];
      if (this.classes !== "") {
        for (let dis of this.disFilter) {
          if (dis.student.class === this.classes) {
            this.disciples.push(dis);
          }
        }
      } else {
        this.getDisciples();
      }
    },
  },
  mounted() {
    this.getDisciples();
    this.getStudent();

    this.userRole = localStorage.getItem("role");
  },
};
</script>

<style scoped>
.cardheader {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
}
.headerManin {
  width: 80%;
}
.header {
  margin-right: 5%;
}
.main {
  height: 84vh;
  overflow-y: scroll;
  margin-top: 3%;
}
.cardForm {
  border-top: 5px solid red;
}
#wearning {
  margin-top: 25%;
}
.searchbtn {
  width: 380px;
  margin-left: -4%;
  margin-top: -5%;
}

img {
  width: 45px;
  height: 35px;
}
#date {
  padding-left: 7px;
  display: flex;
  align-items: center;
}
input[type="date"] {
  width: 80%;
  border-bottom: 1px solid gray;
}
.btn {
  display: flex;
  justify-content: flex-end;
  margin-right: 2%;
  padding-bottom: 5px;
}
</style>
